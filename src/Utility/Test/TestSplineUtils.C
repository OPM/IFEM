//==============================================================================
//!
//! \file TestSplineUtils.C
//!
//! \date Oct 13 2014
//!
//! \author Arne Morten Kvarving / SINTEF
//!
//! \brief Tests for various utility functions on spline objects.
//!
//==============================================================================

#include "SplineUtils.h"
#include "GoTools/utils/Point.h"
#include "GoTools/geometry/SplineSurface.h"
#include "GoTools/geometry/Line.h"
#include "GoTools/geometry/Disc.h"
#include "GoTools/geometry/Plane.h"
#include "GoTools/trivariate/SphereVolume.h"
#include "GoTools/trivariate/SplineVolume.h"
#include "ExprFunctions.h"
#include <fstream>

#include "gtest/gtest.h"


TEST(TestSplineUtils, ToVec3)
{
  Go::Point X(1.0, 2.0, 3.0);
  Vec3 result1 = SplineUtils::toVec3(X,2);
  Vec3 result2 = SplineUtils::toVec3(X,3);
  Vec3 result3 = SplineUtils::toVec3(X);
  EXPECT_FLOAT_EQ(result1.x, 1.0);
  EXPECT_FLOAT_EQ(result1.y, 2.0);
  EXPECT_FLOAT_EQ(result2.x, 1.0);
  EXPECT_FLOAT_EQ(result2.y, 2.0);
  EXPECT_FLOAT_EQ(result2.z, 3.0);
  EXPECT_FLOAT_EQ(result3.x, 1.0);
  EXPECT_FLOAT_EQ(result3.y, 2.0);
  EXPECT_FLOAT_EQ(result3.z, 3.0);
}


TEST(TestSplineUtils, ToVec4)
{
  Go::Point X(1.0, 2.0, 3.0);
  Vec4 result = SplineUtils::toVec4(X,4.0);
  EXPECT_FLOAT_EQ(result.x, 1.0);
  EXPECT_FLOAT_EQ(result.y, 2.0);
  EXPECT_FLOAT_EQ(result.z, 3.0);
  EXPECT_FLOAT_EQ(result.t, 4.0);
}


TEST(TestSplineUtils, PointCurve)
{
  Go::Line line(Go::Point(0.0, 0.0, 0.0), Go::Point(1.0, 0.0, 0.0));
  Go::SplineCurve* crv = line.createSplineCurve();

  Vec3 result;
  SplineUtils::point(result, 0.3, crv);
  EXPECT_FLOAT_EQ(result.x, 0.3);
  EXPECT_FLOAT_EQ(result.y, 0.0);
  EXPECT_FLOAT_EQ(result.z, 0.0);
}


TEST(TestSplineUtils, PointSurface)
{
  Go::Plane plane(Go::Point(0.0, 0.0, 0.0), Go::Point(1.0, 0.0, 0.0));
  Go::SplineSurface* srf = plane.createSplineSurface();

  Vec3 result;
  SplineUtils::point(result, 0.3, 0.3, srf);
  EXPECT_FLOAT_EQ(result.x, 0.0);
  EXPECT_FLOAT_EQ(result.y, 0.3);
  EXPECT_FLOAT_EQ(result.z, 0.3);
}


TEST(TestSplineUtils, PointVolume)
{
  Go::SphereVolume sphere(1.0, Go::Point(0.0, 0.0, 0.0),
                          Go::Point(0.0, 0.0, 1.0), Go::Point(1.0, 0.0, 0.0));
  Go::SplineVolume* vol = sphere.geometryVolume();

  Vec3 result;
  SplineUtils::point(result, 0.3, 0.3, 0.3, vol);
  EXPECT_FLOAT_EQ(result.x, 0.2392104875250847);
  EXPECT_FLOAT_EQ(result.y, 0.1603249784385625);
  EXPECT_FLOAT_EQ(result.z, 0.08410852481577462);
}


TEST(TestSplineUtils, ExtractBasisSurface)
{
  Go::Plane plane(Go::Point(0.0, 0.0, 0.0), Go::Point(0.0, 0.0, 1.0),
                  Go::Point(sqrt(2.0), sqrt(2.0), 0.0));
  Go::SplineSurface* srf = plane.createSplineSurface();
  srf->setParameterDomain(0.0, 1.0, 0.0, 1.0);

  std::vector<Go::BasisDerivsSf> spline;
  std::vector<Go::BasisDerivsSf2> spline2;
  Matrix gpar(1, 1);
  gpar(1,1) = 0.3;
  srf->computeBasisGrid(gpar,gpar,spline);
  srf->raiseOrder(1,1);
  srf->computeBasisGrid(gpar,gpar,spline2);

  Vector N;
  Matrix dNdU;
  Matrix3D d2NdU2;
  SplineUtils::extractBasis(spline[0],N,dNdU);

  const double Nref[] = {0.4899999999999999,
                         0.21,
                         0.21,
                         0.09000000000000002};

  for (size_t i = 0; i < 4; ++i)
    EXPECT_FLOAT_EQ(N[i], Nref[i]);

  const double dNdUref[4][2] = {{-0.7, -0.7},
                                { 0.7, -0.3},
                                {-0.3,  0.7},
                                { 0.3,  0.3}};

  for (size_t i = 0; i < 4; ++i)
    for (size_t j = 0; j < 2; ++j)
      EXPECT_FLOAT_EQ(dNdU(i+1, j+1), dNdUref[i][j]);

  SplineUtils::extractBasis(spline2[0],N,dNdU,d2NdU2);

  const double d2NdU2ref[2][9][2] =
  {{{0.9799999999999999,   1.96},
    {-1.96,               -1.12},
    {0.9799999999999999,  -0.8400000000000001},
    {0.8400000000000001,  -1.12},
    {-1.68,                0.6399999999999997},
    {0.8400000000000001,   0.48},
    {0.18,                -0.8400000000000001},
    {-0.3600000000000001,  0.48},
    {0.18,                 0.3600000000000001}},
   {{1.96,                 0.9799999999999999},
    {-1.12,                0.8400000000000001},
    {-0.8400000000000001,  0.18},
    {-1.12,               -1.96},
    {0.6399999999999997,  -1.68},
    {0.48,                -0.3600000000000001},
    {-0.8400000000000001,  0.9799999999999999},
    {0.48,                 0.8400000000000001},
    {0.3600000000000001,   0.18}}};

  // indices shuffled for more compact constant data representation
  for (size_t i = 0; i < 2; ++i)
    for (size_t j = 0; j < 9; ++j)
      for (size_t k = 0; k < 2; ++k)
        EXPECT_FLOAT_EQ(d2NdU2(j+1, i+1, k+1), d2NdU2ref[i][j][k]);
}


TEST(TestSplineUtils, ExtractBasisVolume)
{
  Go::SphereVolume sphere(1.0, Go::Point(0.0, 0.0, 0.0),
                          Go::Point(0.0, 0.0, 1.0), Go::Point(1.0, 0.0, 0.0));
  Go::SplineVolume* vol = sphere.geometryVolume();
  vol->setParameterDomain(0.0, 1.0, 0.0, 1.0, 0.0, 1.0);

  std::vector<Go::BasisDerivs> spline;
  std::vector<Go::BasisDerivs2> spline2;
  Matrix gpar(1, 1);
  gpar(1,1) = 0.3;
  vol->computeBasisGrid(gpar,gpar,gpar,spline);
  vol->raiseOrder(1,1,1);
  vol->computeBasisGrid(gpar,gpar,gpar,spline2);

  Vector N;
  Matrix dNdU;
  Matrix3D d2NdU2;
  SplineUtils::extractBasis(spline[0],N,dNdU);

  const double Nref[] = {0.09203168159475081,
                         0.03944214925489321,
                         0.03253811306982473,
                         0.01394490560135346,
                         0.005751980099671921,
                         0.002465134328430824,
                         0.1952286784189484,
                         0.08366943360812075,
                         0.06902376119606309,
                         0.0295816119411699,
                         0.01220179240118427,
                         0.005229339600507543,
                         0.2070712835881893,
                         0.0887448358235097,
                         0.07321075440710562,
                         0.03137603760304528,
                         0.01294195522426182,
                         0.005546552238969353};

  for (size_t i = 0; i < 18; ++i)
    EXPECT_FLOAT_EQ(N[i], Nref[i]);

  const double dNdUref[18][3] =
      {{-0.131473830849644,    -0.7775496595279607, -0.9454088359081324 },
       { 0.131473830849644,    -0.3332355683691261, -0.4051752153891997 },
       {-0.04648301867117818,   0.5385475082648621, -0.3342524994321601 },
       { 0.04648301867117818,   0.2308060749706553, -0.1432510711852115 },
       {-0.008217114428102745,  0.2390021512630986, -0.05908805224425824},
       { 0.008217114428102745,  0.1024294933984709, -0.02532345096182496},
       {-0.2788981120270691,   -1.649431910884536,  -0.3786093431017245 },
       { 0.2788981120270691,   -0.7068993903790871, -0.1622611470435962 },
       {-0.09860537313723299,   1.142431785255607,  -0.1338586169639068},
       {0.09860537313723299,    0.489613622252403,  -0.05736797869881721},
       {-0.0174311320016918,    0.50700012562893,   -0.02366308394385777},
       {0.0174311320016918,     0.2172857681266843, -0.01014132169022476},
       {-0.2958161194116989,   -1.749486733937911,   1.324018179009857},
       {0.2958161194116989,    -0.7497800288305334,  0.5674363624327958},
       {-0.1045867920101509,    1.21173189359594,    0.4681111163960667},
       {0.1045867920101509,     0.5193136686839742,  0.2006190498840286},
       {-0.01848850746323117,   0.5377548403419717,  0.08275113618811598},
       {0.01848850746323117,    0.2304663601465594,  0.03546477265204971}};

  for (size_t i = 0; i < 18; ++i)
    for (size_t j = 0; j < 3; ++j)
      EXPECT_FLOAT_EQ(dNdU(i+1, j+1), dNdUref[i][j]);

  const double d2NdU2ref[3][48][3] =
  {{{0.08414325174377223,    0.7921331632010978,   0.8995630360844077},
    {-0.1682865034875444,   -0.4526475218291988,  -0.5140360206196616},
    {0.08414325174377221,   -0.3394856413718992,  -0.3855270154647463},
    {0.0507849448854971,    -0.4106418790448018,   0.5429343204811236},
    {-0.1015698897709942,    0.2346525023113152,  -0.3102481831320706},
    {0.05078494488549709,    0.1759893767334865,  -0.232686137349053},
    {0.01269623622137427,   -0.3248446036352501,   0.1357335801202809},
    {-0.02539247244274854,   0.1856254877915715,  -0.07756204578301762},
    {0.01269623622137427,    0.1392191158436786,  -0.05817153433726324},
    {0.00131473830849644,   -0.05664668052104593,  0.01405567243881886},
    {-0.002629476616992879,  0.03236953172631196, -0.008031812822182205},
    {0.00131473830849644,    0.02427714879473398, -0.006023859616636655},
    {0.3047096693129827,     2.868567938708386,    1.480132851894343},
    {-0.6094193386259653,   -1.639181679261935,   -0.8457902010824817},
    {0.3047096693129827,    -1.229386259446451,   -0.6343426508118615},
    {0.1839085540604059,    -1.487065790502499,    0.8933392012893226},
    {-0.3678171081208118,    0.849751880287142,   -0.5104795435938986},
    {0.1839085540604059,     0.6373139102153568,  -0.3828596576954241},
    {0.04597713851510146,   -1.1763663716399,      0.2233348003223306},
    {-0.09195427703020291,   0.6722093552227999,  -0.1276198858984746},
    {0.04597713851510146,    0.5041570164171001,  -0.09571491442385599},
    {0.004761088583015351,  -0.2051357765659874,   0.02312707581084909},
    {-0.009522177166030699,  0.1172204437519928,  -0.01321547189191376},
    {0.00476108858301535,    0.08791533281399462, -0.009911603918935327},
    {0.457064503969474,      4.302851908062578,   -0.446010328647082},
    {-0.9141290079389477,   -2.458772518892901,    0.2548630449411897},
    {0.4570645039694738,    -1.844079389169677,    0.1911472837058923},
    {0.2758628310906088,    -2.230598685753748,   -0.2691910460945667},
    {-0.5517256621812174,    1.274627820430713,    0.1538234549111809},
    {0.2758628310906087,     0.9559708653230349,   0.1153675911833857},
    {0.06896570777265217,   -1.76454955745985,    -0.06729776152364164},
    {-0.1379314155453043,    1.0083140328342,      0.03845586372779522},
    {0.06896570777265215,    0.75623552462565,     0.02884189779584642},
    {0.007141632874523024,  -0.3077036648489809,  -0.00696891138511065},
    {-0.01428326574904604,   0.1758306656279891,   0.003982235077206085},
    {0.007141632874523022,   0.1318729992209919,   0.002986676307904564},
    {0.2839834746352312,     2.673449425803705,   -1.933685559331669},
    {-0.5679669492704623,   -1.527685386173546,    1.104963176760954},
    {0.2839834746352312,    -1.14576403963016,     0.8287223825707156},
    {0.1713991889885527,    -1.385916341776206,   -1.16708247567588},
    {-0.3427983779771053,    0.7919521953006888,   0.6669042718147881},
    {0.1713991889885526,     0.5939641464755168,   0.5001782038610914},
    {0.04284979724713816,   -1.096350537268969,   -0.2917706189189698},
    {-0.08569959449427629,   0.6264860212965535,   0.166726067953697},
    {0.04284979724713815,    0.4698645159724153,   0.1250445509652728},
    {0.004437241791175483,  -0.19118254675853,    -0.03021383686455731},
    {-0.008874483582350965,  0.1092471695763028,   0.01726504963688989},
    {0.004437241791175483,   0.08193537718222718,  0.01294878722766742}},
   {{0.7921331632010978,     1.805690858410506,    4.234289134927958},
    {-0.4526475218291988,    1.54773502149472,     3.629390687081107},
    {-0.3394856413718992,    0.3316575046060115,   0.7777265758030946},
    {-0.4106418790448018,   -4.166247773705821,   -2.195055740071803},
    {0.2346525023113152,    -3.571069520319276,   -1.881476348632975},
    {0.1759893767334865,    -0.7652291829255592,  -0.4031735032784947},
    {-0.3248446036352501,    1.532640745953726,   -1.736432761070408},
    {0.1856254877915715,     1.313692067960337,   -1.48837093806035},
    {0.1392191158436786,     0.2815054431343579,  -0.3189366295843608},
    {-0.05664668052104593,   0.8279161693415887,  -0.3028006337857458},
    {0.03236953172631196,    0.7096424308642191,  -0.2595434003877822},
    {0.02427714879473398,    0.1520662351851898,  -0.05561644294023905},
    {2.868567938708386,      6.538985039741638,    6.967060896928714},
    {-1.639181679261935,     5.604844319778548,    5.971766483081757},
    {-1.229386259446451,     1.201038068523975,    1.279664246374662},
    {-1.487065790502499,   -15.08731781923096,    -3.611724784470435},
    {0.849751880287142,    -12.93198670219797,    -3.095764100974659},
    {0.6373139102153568,    -2.771140007613851,   -0.6633780216374271},
    {-1.1763663716399,       5.550183112690656,   -2.857110698938002},
    {0.6722093552227999,     4.757299810877706,   -2.448952027661145},
    {0.5041570164171001,     1.019421388045223,   -0.5247754344988168},
    {-0.2051357765659874,    2.998149666798665,   -0.4982254135202778},
    {0.1172204437519928,     2.569842571541714,   -0.4270503544459525},
    {0.08791533281399462,    0.5506805510446531,  -0.0915107902384184},
    {4.302851908062578,      9.808477559612456,   -2.099393386456113},
    {-2.458772518892901,     8.40726647966782,    -1.799480045533812},
    {-1.844079389169677,     1.801557102785962,   -0.3856028669001025},
    {-2.230598685753748,   -22.63097672884644,     1.088325656742777},
    {1.274627820430713,    -19.39798005329695,     0.9328505629223806},
    {0.9559708653230349,    -4.156710011420776,    0.199896549197653},
    {-1.76454955745985,      8.325274669035982,    0.8609368275175585},
    {1.0083140328342,        7.135949716316557,    0.7379458521579075},
    {0.75623552462565,       1.529132082067834,    0.1581312540338373},
    {-0.3077036648489809,    4.497224500197997,    0.1501309021957778},
    {0.1758306656279891,     3.85476385731257,     0.1286836304535239},
    {0.1318729992209919,     0.8260208265669793,   0.02757506366861226},
    {2.673449425803705,      6.094206647135456,   -9.101956645400559},
    {-1.527685386173546,     5.223605697544678,   -7.801677124629053},
    {-1.14576403963016,      1.119344078045288,   -1.671787955277654},
    {-1.385916341776206,   -14.06108623625714,     4.718454867799463},
    {0.7919521953006888,   -12.05235963107755,     4.044389886685255},
    {0.5939641464755168,    -2.582648492373762,    0.8666549757182691},
    {-1.096350537268969,     5.172662517593825,    3.73260663249085},
    {0.6264860212965535,     4.433710729366137,    3.199377113563587},
    {0.4698645159724153,     0.9500808705784581,   0.6855808100493401},
    {-0.19118254675853,      2.794217071527862,    0.6508951451102458},
    {0.1092471695763028,     2.395043204166739,    0.5579101243802108},
    {0.08193537718222718,    0.5132235437500157,   0.1195521695100452}},
   {{0.8995630360844077,     4.234289134927958,    3.151535495216084},
    {-0.5140360206196616,    3.629390687081107,    2.701316138756644},
    {-0.3855270154647463,    0.7777265758030946,   0.5788534583049951},
    {0.5429343204811236,    -2.195055740071803,    1.902119933712718},
    {-0.3102481831320706,   -1.881476348632975,    1.630388514610902},
    {-0.232686137349053,    -0.4031735032784947,   0.3493689674166219},
    {0.1357335801202809,    -1.736432761070408,    0.4755299834281795},
    {-0.07756204578301762,  -1.48837093806035,     0.4075971286527253},
    {-0.05817153433726324,  -0.3189366295843608,   0.08734224185415546},
    {0.01405567243881886,   -0.3028006337857458,   0.04924274211275127},
    {-0.008031812822182205, -0.2595434003877822,   0.04220806466807252},
    {-0.006023859616636655, -0.05561644294023905,  0.009044585286015542},
    {1.480132851894343,      6.967060896928714,   -1.368825866089619},
    {-0.8457902010824817,    5.971766483081757,   -1.173279313791102},
    {-0.6343426508118615,    1.279664246374662,   -0.2514169958123791},
    {0.8933392012893226,    -3.611724784470435,   -0.8261594926101637},
    {-0.5104795435938986,   -3.095764100974659,   -0.708136707951569},
    {-0.3828596576954241,   -0.6633780216374271,  -0.1517435802753363},
    {0.2233348003223306,    -2.857110698938002,   -0.2065398731525409},
    {-0.1276198858984746,   -2.448952027661145,   -0.1770341769878922},
    {-0.09571491442385599,  -0.5247754344988168,  -0.03793589506883405},
    {0.02312707581084909,   -0.4982254135202778,  -0.02138790415765027},
    {-0.01321547189191376,  -0.4270503544459525,  -0.01833248927798595},
    {-0.009911603918935327, -0.0915107902384184,  -0.003928390559568419},
    {-0.446010328647082,    -2.099393386456113,   -5.67266763049984},
    {0.2548630449411897,    -1.799480045533812,   -4.862286540428435},
    {0.1911472837058923,    -0.3856028669001025,  -1.041918544377522},
    {-0.2691910460945667,    1.088325656742777,   -3.42375778209689},
    {0.1538234549111809,     0.9328505629223806,  -2.93464952751162},
    {0.1153675911833857,     0.199896549197653,   -0.6288534701810616},
    {-0.06729776152364164,   0.8609368275175585,  -0.8559394455242222},
    {0.03845586372779522,    0.7379458521579075,  -0.7336623818779049},
    {0.02884189779584642,    0.1581312540338373,  -0.1572133675452654},
    {-0.00696891138511065,   0.1501309021957778,  -0.08863543172655991},
    {0.003982235077206085,   0.1286836304535239,  -0.07597322719419423},
    {0.002986676307904564,   0.02757506366861226, -0.01627997725589877},
    {-1.933685559331669,    -9.101956645400559,    3.889958001373377},
    {1.104963176760954,     -7.801677124629053,    3.334249715462895},
    {0.8287223825707156,    -1.671787955277654,    0.7144820818849061},
    {-1.16708247567588,      4.718454867799463,    2.347797340994335},
    {0.6669042718147881,     4.044389886685255,    2.012397720852288},
    {0.5001782038610914,     0.8666549757182691,   0.431228083039776},
    {-0.2917706189189698,    3.73260663249085,     0.5869493352485836},
    {0.166726067953697,      3.199377113563587,    0.5030994302130718},
    {0.1250445509652728,     0.6855808100493401,   0.107807020759944},
    {-0.03021383686455731,   0.6508951451102458,   0.06078059377145895},
    {0.01726504963688989,    0.5579101243802108,   0.05209765180410768},
    {0.01294878722766742,    0.1195521695100452,   0.01116378252945165}}};

  SplineUtils::extractBasis(spline2[0],N,dNdU,d2NdU2);

  // indices shuffled for more compact constant data representation
  for (size_t i = 0; i < 3; ++i)
    for (size_t j = 0; j < 48; ++j)
      for (size_t k = 0; k < 3; ++k)
        EXPECT_FLOAT_EQ(d2NdU2(j+1, k+1, i+1), d2NdU2ref[i][j][k]);
}


TEST(TestSplineUtils, ProjectCurve)
{
  Go::Line line(Go::Point(0.0, 0.0, 0.0), Go::Point(1.0, 0.0, 0.0));
  Go::SplineCurve* crv = line.createSplineCurve();
  crv->setParameterInterval(0.0, 2*M_PI);

  EvalFunction func("sin(x)*t");
  VecFuncExpr func2("sin(x)*t|cos(x)*t");
  Go::SplineCurve* prjCrv  = SplineUtils::project(crv, func , 1, 0.1);
  Go::SplineCurve* prjCrv2 = SplineUtils::project(crv, func2, 2, 0.1);

  Vec3 result1, result2, result3, result4;
  SplineUtils::point(result1, 0.5, prjCrv);
  SplineUtils::point(result2, 0.8, prjCrv);
  SplineUtils::point(result3, 0.5, prjCrv2);
  SplineUtils::point(result4, 0.8, prjCrv2);

  EXPECT_FLOAT_EQ(result1.x, -0.0783364);
  EXPECT_FLOAT_EQ(result2.x, -0.0694399);
  EXPECT_FLOAT_EQ(result3.x, -0.0783364);
  EXPECT_FLOAT_EQ(result3.y, -0.0363385);
  EXPECT_FLOAT_EQ(result4.x, -0.0694399);
  EXPECT_FLOAT_EQ(result4.y, -0.0363385);
}


TEST(TestSplineUtils, ProjectSurface)
{
  Go::Disc disc(Go::Point(0.0, 0.0, 0.0), 1.0,
                Go::Point(1.0/sqrt(2.0), 1.0/sqrt(2.0), 0.0),
                Go::Point(0.0, 0.0, 1.0));
  Go::SplineSurface* srf = disc.createSplineSurface();
  srf->setParameterDomain(0.0, 1.0, 0.0, 1.0);

  EvalFunction func("sin(x)*sin(y)*t");
  VecFuncExpr func2("sin(x)*sin(y)*t|cos(x)*cos(y)*t");
  Go::SplineSurface* prjSrf  = SplineUtils::project(srf, func , 1, 0.1);
  Go::SplineSurface* prjSrf2 = SplineUtils::project(srf, func2, 2, 0.1);

  Vec3 result1, result2, result3, result4;
  SplineUtils::point(result1, 0.5, 0.5, prjSrf);
  SplineUtils::point(result2, 0.8, 0.8, prjSrf);
  SplineUtils::point(result3, 0.5, 0.5, prjSrf2);
  SplineUtils::point(result4, 0.8, 0.8, prjSrf2);
  EXPECT_FLOAT_EQ(result1.x,  0.02110140763086564);
  EXPECT_FLOAT_EQ(result2.x, -0.02189938149140131);
  EXPECT_FLOAT_EQ(result3.x,  0.02110140763086564);
  EXPECT_FLOAT_EQ(result3.y,  0.07889859236913437);
  EXPECT_FLOAT_EQ(result4.x, -0.02189938149140131);
  EXPECT_FLOAT_EQ(result4.y,  0.06514225417205573);
}
