//==============================================================================
//!
//! \file TestThreadGroups.C
//!
//! \date Oct 13 2014
//!
//! \author Arne Morten Kvarving / SINTEF
//!
//! \brief Tests for threading group partitioning.
//!
//==============================================================================

#include "ThreadGroups.h"
#ifdef USE_OPENMP
#include <omp.h>
#endif
#include <fstream>

#include "gtest/gtest.h"


TEST(TestThreadGroups, Groups2D)
{
  ThreadGroups groups;
#ifdef USE_OPENMP
  omp_set_num_threads(2);
#endif

  groups.calcGroups(8, 8, 2);

#ifdef USE_OPENMP
  ASSERT_EQ(groups.size(), 2U);
  ASSERT_EQ(groups[0].size(), 2U);
  ASSERT_EQ(groups[0][0].size(), 16U);
  ASSERT_EQ(groups[0][1].size(), 16U);
  ASSERT_EQ(groups[1].size(), 2U);
  ASSERT_EQ(groups[1][0].size(), 16U);
  ASSERT_EQ(groups[1][1].size(), 16U);

  const int ref2D[2][2][16] =
    {{{ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15},
      {32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47}},
     {{16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31},
      {48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63}}};

  for (size_t i = 0; i < 2; ++i)
    for (size_t j = 0; j < 2; ++j)
      for (size_t k = 0; k < 16; ++k)
        EXPECT_EQ(groups[i][j][k], ref2D[i][j][k]);
#else
  ASSERT_EQ(groups.size(), 1U);
  ASSERT_EQ(groups[0].size(), 1U);
  ASSERT_EQ(groups[0][0].size(), 64U);
  for (int i = 0; i < 64; ++i)
    EXPECT_EQ(groups[0][0][i], i);
#endif

  std::vector<bool> b14(4, true);
  std::vector<bool> b24(4, true);

  for (int i = 0; i < 2; ++i) {
    ThreadGroups group((ThreadGroups::StripDirection)i);
    group.calcGroups(b14, b24, 1, 1);
#ifdef USE_OPENMP
    const int ref1[4][4] = {{0,4,8,12}, {2,6,10,14},
                            {0,1,2, 3}, {8,9,10,11}};

    const int ref2[4][4] = {{1,5,9,13}, { 3, 7,11,15},
                            {4,5,6, 7}, {12,13,14,15}};

    ASSERT_EQ(group.size(), 2U);
    ASSERT_EQ(group[0].size(), 2U);
    ASSERT_EQ(group[1].size(), 2U);
    ASSERT_EQ(group[0][0].size(), 4U);
    ASSERT_EQ(group[0][1].size(), 4U);
    ASSERT_EQ(group[1][0].size(), 4U);
    ASSERT_EQ(group[1][1].size(), 4U);
    for (size_t j = 0; j < 4; ++j) {
      ASSERT_EQ(group[0][0][j], ref1[i*2][j]);
      ASSERT_EQ(group[0][1][j], ref1[i*2+1][j]);
      ASSERT_EQ(group[1][0][j], ref2[i*2][j]);
      ASSERT_EQ(group[1][1][j], ref2[i*2+1][j]);
    }
#else
    ASSERT_EQ(group.size(), 1U);
    ASSERT_EQ(group[0].size(), 1U);
    ASSERT_EQ(group[0][0].size(), 16U);
    for (int j = 0; j < 16; ++j)
      ASSERT_EQ(group[0][0][j], j);
#endif
  }

#ifdef USE_OPENMP
  omp_set_num_threads(3);
#endif
  ThreadGroups groups2;
  std::vector<bool> b1(12, true);
  b1[3] = false;
  std::vector<bool> b2(12, true);
  b1[6] = false;
  groups2.calcGroups(b1, b2, 2, 2);
#ifdef USE_OPENMP
  const int ref2De[2][3][24] =
    {{{  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,  14,
        15,  16,  17,  18,  19,  20,  21,  22,  23},
      { 48,  49,  50,  51,  52,  53,  54,  55,  56,  57,  58,  59,  60,  61,  62,
        63,  64,  65,  66,  67,  68,  69,  70,  71},
      { 96,  97,  98,  99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110,
       111, 112, 113, 114, 115, 116, 117, 118, 119}},
     {{ 24,  25,  26,  27,  28,  29,  30,  31,  32,  33,  34,  35,  36,  37,  38,
        39,  40,  41,  42,  43,  44,  45,  46,  47},
      { 72,  73,  74,  75,  76,  77,  78,  79,  80,  81,  82,  83,  84,  85,  86,
        87,  88,  89,  90,  91,  92,  93,  94,  95},
      {120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134,
       135, 136, 137, 138, 139, 140, 141, 142, 143}}};

  ASSERT_EQ(groups2.size(), 2U);
  ASSERT_EQ(groups2[0].size(), 3U);
  ASSERT_EQ(groups2[1].size(), 3U);
  for (size_t i = 0; i < 2; ++i)
    for (size_t j = 0; j < 3; ++j)
      ASSERT_EQ(groups2[i][j].size(), 24U);

  for (size_t i = 0; i < 2; ++i)
    for (size_t j = 0; j < 3; ++j)
      for (size_t k = 0; k < 24; ++k)
        EXPECT_EQ(groups2[i][j][k], ref2De[i][j][k]);
#else
  ASSERT_EQ(groups2.size(), 1U);
  ASSERT_EQ(groups2[0].size(), 1U);
  ASSERT_EQ(groups2[0][0].size(), 144U);
  for (int i = 0; i < 144; ++i)
    EXPECT_EQ(groups2[0][0][i], i);
#endif
}

TEST(TestThreadGroups, Groups3D)
{
  ThreadGroups groups;
#ifdef USE_OPENMP
  omp_set_num_threads(2);
#endif

  groups.calcGroups(8, 8, 8, 2);

#ifdef USE_OPENMP
  ASSERT_EQ(groups.size(), 2U);

  const int ref3D[2][2][128] =
    {{{  0,   1,   8,   9,  16,  17,  24,  25,  32,  33,  40,  41,  48,  49,  56,
        57,  64,  65,  72,  73,  80,  81,  88,  89,  96,  97, 104, 105, 112, 113,
       120, 121, 128, 129, 136, 137, 144, 145, 152, 153, 160, 161, 168, 169, 176,
       177, 184, 185, 192, 193, 200, 201, 208, 209, 216, 217, 224, 225, 232, 233,
       240, 241, 248, 249, 256, 257, 264, 265, 272, 273, 280, 281, 288, 289, 296,
       297, 304, 305, 312, 313, 320, 321, 328, 329, 336, 337, 344, 345, 352, 353,
       360, 361, 368, 369, 376, 377, 384, 385, 392, 393, 400, 401, 408, 409, 416,
       417, 424, 425, 432, 433, 440, 441, 448, 449, 456, 457, 464, 465, 472, 473,
       480, 481, 488, 489, 496, 497, 504, 505},
    {    4,   5,  12,  13,  20,  21,  28,  29,  36,  37,  44,  45,  52,  53,  60,
        61,  68,  69,  76,  77,  84,  85,  92,  93, 100, 101, 108, 109, 116, 117,
       124, 125, 132, 133, 140, 141, 148, 149, 156, 157, 164, 165, 172, 173, 180,
       181, 188, 189, 196, 197, 204, 205, 212, 213, 220, 221, 228, 229, 236, 237,
       244, 245, 252, 253, 260, 261, 268, 269, 276, 277, 284, 285, 292, 293, 300,
       301, 308, 309, 316, 317, 324, 325, 332, 333, 340, 341, 348, 349, 356, 357,
       364, 365, 372, 373, 380, 381, 388, 389, 396, 397, 404, 405, 412, 413, 420,
       421, 428, 429, 436, 437, 444, 445, 452, 453, 460, 461, 468, 469, 476, 477,
       484, 485, 492, 493, 500, 501, 508, 509}},
    {{   2,   3,  10,  11,  18,  19,  26,  27,  34,  35,  42,  43,  50,  51,  58,
        59,  66,  67,  74,  75,  82,  83,  90,  91,  98,  99, 106, 107, 114, 115,
       122, 123, 130, 131, 138, 139, 146, 147, 154, 155, 162, 163, 170, 171, 178,
       179, 186, 187, 194, 195, 202, 203, 210, 211, 218, 219, 226, 227, 234, 235,
       242, 243, 250, 251, 258, 259, 266, 267, 274, 275, 282, 283, 290, 291, 298,
       299, 306, 307, 314, 315, 322, 323, 330, 331, 338, 339, 346, 347, 354, 355,
       362, 363, 370, 371, 378, 379, 386, 387, 394, 395, 402, 403, 410, 411, 418,
       419, 426, 427, 434, 435, 442, 443, 450, 451, 458, 459, 466, 467, 474, 475,
       482, 483, 490, 491, 498, 499, 506, 507},
    {    6,   7,  14,  15,  22,  23,  30,  31,  38,  39,  46,  47,  54,  55,  62,
        63,  70,  71,  78,  79,  86,  87,  94,  95, 102, 103, 110, 111, 118, 119,
       126, 127, 134, 135, 142, 143, 150, 151, 158, 159, 166, 167, 174, 175, 182,
       183, 190, 191, 198, 199, 206, 207, 214, 215, 222, 223, 230, 231, 238, 239,
       246, 247, 254, 255, 262, 263, 270, 271, 278, 279, 286, 287, 294, 295, 302,
       303, 310, 311, 318, 319, 326, 327, 334, 335, 342, 343, 350, 351, 358, 359,
       366, 367, 374, 375, 382, 383, 390, 391, 398, 399, 406, 407, 414, 415, 422,
       423, 430, 431, 438, 439, 446, 447, 454, 455, 462, 463, 470, 471, 478, 479,
       486, 487, 494, 495, 502, 503, 510, 511}}};

  ASSERT_EQ(groups.size(), 2U);
  ASSERT_EQ(groups[0].size(), 2U);
  ASSERT_EQ(groups[0][0].size(), 128U);
  ASSERT_EQ(groups[0][1].size(), 128U);
  ASSERT_EQ(groups[1].size(), 2U);
  ASSERT_EQ(groups[1][0].size(), 128U);
  ASSERT_EQ(groups[1][1].size(), 128U);

  for (size_t i = 0; i < 2; ++i)
    for (size_t j = 0; j < 2; ++j)
      for (size_t k = 0; k < 128; ++k)
        EXPECT_EQ(groups[i][j][k], ref3D[i][j][k]);
#else
  ASSERT_EQ(groups.size(), 1U);
  ASSERT_EQ(groups[0].size(), 1U);
  ASSERT_EQ(groups[0][0].size(), 512U);
  for (int i = 0; i < 512; ++i)
    EXPECT_EQ(groups[0][0][i], i);
#endif

#ifdef USE_OPENMP
  omp_set_num_threads(3);
#endif
  ThreadGroups groups2;
  std::vector<bool> b1(14, true);
  b1[3] = false;
  std::vector<bool> b2(14, true);
  b2[6] = false;
  std::vector<bool> b3(14, true);
  b3[7] = false;
  groups2.calcGroups(b1, b2, b3, 2, 2, 2);

#ifdef USE_OPENMP
  ASSERT_EQ(groups.size(), 2U);
  const int ref3De1[3][392] =
    {{    0,    1,   14,   15,   28,   29,   42,   43,   56,   57,   70,   71,
         84,   85,   98,   99,  112,  113,  126,  127,  140,  141,  154,  155,
        168,  169,  182,  183,  196,  197,  210,  211,  224,  225,  238,  239,
        252,  253,  266,  267,  280,  281,  294,  295,  308,  309,  322,  323,
        336,  337,  350,  351,  364,  365,  378,  379,  392,  393,  406,  407,
        420,  421,  434,  435,  448,  449,  462,  463,  476,  477,  490,  491,
        504,  505,  518,  519,  532,  533,  546,  547,  560,  561,  574,  575,
        588,  589,  602,  603,  616,  617,  630,  631,  644,  645,  658,  659,
        672,  673,  686,  687,  700,  701,  714,  715,  728,  729,  742,  743,
        756,  757,  770,  771,  784,  785,  798,  799,  812,  813,  826,  827,
        840,  841,  854,  855,  868,  869,  882,  883,  896,  897,  910,  911,
        924,  925,  938,  939,  952,  953,  966,  967,  980,  981,  994,  995,
       1008, 1009, 1022, 1023, 1036, 1037, 1050, 1051, 1064, 1065, 1078, 1079,
       1092, 1093, 1106, 1107, 1120, 1121, 1134, 1135, 1148, 1149, 1162, 1163,
       1176, 1177, 1190, 1191, 1204, 1205, 1218, 1219, 1232, 1233, 1246, 1247,
       1260, 1261, 1274, 1275, 1288, 1289, 1302, 1303, 1316, 1317, 1330, 1331,
       1344, 1345, 1358, 1359, 1372, 1373, 1386, 1387, 1400, 1401, 1414, 1415,
       1428, 1429, 1442, 1443, 1456, 1457, 1470, 1471, 1484, 1485, 1498, 1499,
       1512, 1513, 1526, 1527, 1540, 1541, 1554, 1555, 1568, 1569, 1582, 1583,
       1596, 1597, 1610, 1611, 1624, 1625, 1638, 1639, 1652, 1653, 1666, 1667,
       1680, 1681, 1694, 1695, 1708, 1709, 1722, 1723, 1736, 1737, 1750, 1751,
       1764, 1765, 1778, 1779, 1792, 1793, 1806, 1807, 1820, 1821, 1834, 1835,
       1848, 1849, 1862, 1863, 1876, 1877, 1890, 1891, 1904, 1905, 1918, 1919,
       1932, 1933, 1946, 1947, 1960, 1961, 1974, 1975, 1988, 1989, 2002, 2003,
       2016, 2017, 2030, 2031, 2044, 2045, 2058, 2059, 2072, 2073, 2086, 2087,
       2100, 2101, 2114, 2115, 2128, 2129, 2142, 2143, 2156, 2157, 2170, 2171,
       2184, 2185, 2198, 2199, 2212, 2213, 2226, 2227, 2240, 2241, 2254, 2255,
       2268, 2269, 2282, 2283, 2296, 2297, 2310, 2311, 2324, 2325, 2338, 2339,
       2352, 2353, 2366, 2367, 2380, 2381, 2394, 2395, 2408, 2409, 2422, 2423,
       2436, 2437, 2450, 2451, 2464, 2465, 2478, 2479, 2492, 2493, 2506, 2507,
       2520, 2521, 2534, 2535, 2548, 2549, 2562, 2563, 2576, 2577, 2590, 2591,
       2604, 2605, 2618, 2619, 2632, 2633, 2646, 2647, 2660, 2661, 2674, 2675,
       2688, 2689, 2702, 2703, 2716, 2717, 2730, 2731},
      {   5,    6,   19,   20,   33,   34,   47,   48,   61,   62,   75,   76,
         89,   90,  103,  104,  117,  118,  131,  132,  145,  146,  159,  160,
        173,  174,  187,  188,  201,  202,  215,  216,  229,  230,  243,  244,
        257,  258,  271,  272,  285,  286,  299,  300,  313,  314,  327,  328,
        341,  342,  355,  356,  369,  370,  383,  384,  397,  398,  411,  412,
        425,  426,  439,  440,  453,  454,  467,  468,  481,  482,  495,  496,
        509,  510,  523,  524,  537,  538,  551,  552,  565,  566,  579,  580,
        593,  594,  607,  608,  621,  622,  635,  636,  649,  650,  663,  664,
        677,  678,  691,  692,  705,  706,  719,  720,  733,  734,  747,  748,
        761,  762,  775,  776,  789,  790,  803,  804,  817,  818,  831,  832,
        845,  846,  859,  860,  873,  874,  887,  888,  901,  902,  915,  916,
        929,  930,  943,  944,  957,  958,  971,  972,  985,  986,  999, 1000,
       1013, 1014, 1027, 1028, 1041, 1042, 1055, 1056, 1069, 1070, 1083, 1084,
       1097, 1098, 1111, 1112, 1125, 1126, 1139, 1140, 1153, 1154, 1167, 1168,
       1181, 1182, 1195, 1196, 1209, 1210, 1223, 1224, 1237, 1238, 1251, 1252,
       1265, 1266, 1279, 1280, 1293, 1294, 1307, 1308, 1321, 1322, 1335, 1336,
       1349, 1350, 1363, 1364, 1377, 1378, 1391, 1392, 1405, 1406, 1419, 1420,
       1433, 1434, 1447, 1448, 1461, 1462, 1475, 1476, 1489, 1490, 1503, 1504,
       1517, 1518, 1531, 1532, 1545, 1546, 1559, 1560, 1573, 1574, 1587, 1588,
       1601, 1602, 1615, 1616, 1629, 1630, 1643, 1644, 1657, 1658, 1671, 1672,
       1685, 1686, 1699, 1700, 1713, 1714, 1727, 1728, 1741, 1742, 1755, 1756,
       1769, 1770, 1783, 1784, 1797, 1798, 1811, 1812, 1825, 1826, 1839, 1840,
       1853, 1854, 1867, 1868, 1881, 1882, 1895, 1896, 1909, 1910, 1923, 1924,
       1937, 1938, 1951, 1952, 1965, 1966, 1979, 1980, 1993, 1994, 2007, 2008,
       2021, 2022, 2035, 2036, 2049, 2050, 2063, 2064, 2077, 2078, 2091, 2092,
       2105, 2106, 2119, 2120, 2133, 2134, 2147, 2148, 2161, 2162, 2175, 2176,
       2189, 2190, 2203, 2204, 2217, 2218, 2231, 2232, 2245, 2246, 2259, 2260,
       2273, 2274, 2287, 2288, 2301, 2302, 2315, 2316, 2329, 2330, 2343, 2344,
       2357, 2358, 2371, 2372, 2385, 2386, 2399, 2400, 2413, 2414, 2427, 2428,
       2441, 2442, 2455, 2456, 2469, 2470, 2483, 2484, 2497, 2498, 2511, 2512,
       2525, 2526, 2539, 2540, 2553, 2554, 2567, 2568, 2581, 2582, 2595, 2596,
       2609, 2610, 2623, 2624, 2637, 2638, 2651, 2652, 2665, 2666, 2679, 2680,
       2693, 2694, 2707, 2708, 2721, 2722, 2735, 2736},
      {   9,   10,   23,   24,   37,   38,   51  , 52,   65,   66,   79,   80,
         93,   94,  107,  108,  121,  122,  135,  136,  149,  150,  163,  164,
        177,  178,  191,  192,  205,  206,  219,  220,  233,  234,  247,  248,
        261,  262,  275,  276,  289,  290,  303,  304,  317,  318,  331,  332,
        345,  346,  359,  360,  373,  374,  387,  388,  401,  402,  415,  416,
        429,  430,  443,  444,  457,  458,  471,  472,  485,  486,  499,  500,
        513,  514,  527,  528,  541,  542,  555,  556,  569,  570,  583,  584,
        597,  598,  611,  612,  625,  626,  639,  640,  653,  654,  667,  668,
        681,  682,  695,  696,  709,  710,  723,  724,  737,  738,  751,  752,
        765,  766,  779,  780,  793,  794,  807,  808,  821,  822,  835,  836,
        849,  850,  863,  864,  877,  878,  891,  892,  905,  906,  919,  920,
        933,  934,  947,  948,  961,  962,  975,  976,  989,  990, 1003, 1004,
       1017, 1018, 1031, 1032, 1045, 1046, 1059, 1060, 1073, 1074, 1087, 1088,
       1101, 1102, 1115, 1116, 1129, 1130, 1143, 1144, 1157, 1158, 1171, 1172,
       1185, 1186, 1199, 1200, 1213, 1214, 1227, 1228, 1241, 1242, 1255, 1256,
       1269, 1270, 1283, 1284, 1297, 1298, 1311, 1312, 1325, 1326, 1339, 1340,
       1353, 1354, 1367, 1368, 1381, 1382, 1395, 1396, 1409, 1410, 1423, 1424,
       1437, 1438, 1451, 1452, 1465, 1466, 1479, 1480, 1493, 1494, 1507, 1508,
       1521, 1522, 1535, 1536, 1549, 1550, 1563, 1564, 1577, 1578, 1591, 1592,
       1605, 1606, 1619, 1620, 1633, 1634, 1647, 1648, 1661, 1662, 1675, 1676,
       1689, 1690, 1703, 1704, 1717, 1718, 1731, 1732, 1745, 1746, 1759, 1760,
       1773, 1774, 1787, 1788, 1801, 1802, 1815, 1816, 1829, 1830, 1843, 1844,
       1857, 1858, 1871, 1872, 1885, 1886, 1899, 1900, 1913, 1914, 1927, 1928,
       1941, 1942, 1955, 1956, 1969, 1970, 1983, 1984, 1997, 1998, 2011, 2012,
       2025, 2026, 2039, 2040, 2053, 2054, 2067, 2068, 2081, 2082, 2095, 2096,
       2109, 2110, 2123, 2124, 2137, 2138, 2151, 2152, 2165, 2166, 2179, 2180,
       2193, 2194, 2207, 2208, 2221, 2222, 2235, 2236, 2249, 2250, 2263, 2264,
       2277, 2278, 2291, 2292, 2305, 2306, 2319, 2320, 2333, 2334, 2347, 2348,
       2361, 2362, 2375, 2376, 2389, 2390, 2403, 2404, 2417, 2418, 2431, 2432,
       2445, 2446, 2459, 2460, 2473, 2474, 2487, 2488, 2501, 2502, 2515, 2516,
       2529, 2530, 2543, 2544, 2557, 2558, 2571, 2572, 2585, 2586, 2599, 2600,
       2613, 2614, 2627, 2628, 2641, 2642, 2655, 2656, 2669, 2670, 2683, 2684,
       2697, 2698, 2711, 2712, 2725, 2726, 2739, 2740}};

  const std::array<std::vector<int>,3> ref3De2 =
   {{{   2,    3,    4,   16,   17,   18,   30,   31,   32,   44,   45,   46,
        58,   59,   60,   72,   73,   74,   86,   87,   88,  100,  101,  102,
       114,  115,  116,  128,  129,  130,  142,  143,  144,  156,  157,  158,
       170,  171,  172,  184,  185,  186,  198,  199,  200,  212,  213,  214,
       226,  227,  228,  240,  241,  242,  254,  255,  256,  268,  269,  270,
       282,  283,  284,  296,  297,  298,  310,  311,  312,  324,  325,  326,
       338,  339,  340,  352,  353,  354,  366,  367,  368,  380,  381,  382,
       394,  395,  396,  408,  409,  410,  422,  423,  424,  436,  437,  438,
       450,  451,  452,  464,  465,  466,  478,  479,  480,  492 , 493,  494,
       506,  507,  508,  520,  521,  522,  534,  535,  536,  548,  549,  550,
       562,  563,  564,  576,  577,  578,  590,  591,  592,  604,  605,  606,
       618,  619,  620,  632,  633,  634,  646,  647,  648,  660,  661,  662,
       674,  675,  676,  688,  689,  690,  702,  703,  704,  716,  717,  718,
       730,  731,  732,  744,  745,  746,  758,  759,  760,  772,  773,  774,
       786,  787,  788,  800,  801,  802,  814,  815,  816,  828,  829,  830,
       842,  843,  844,  856,  857,  858,  870,  871,  872,  884,  885,  886,
       898,  899,  900,  912,  913,  914,  926,  927,  928,  940,  941,  942,
       954,  955,  956,  968,  969,  970,  982,  983,  984,  996,  997,  998,
      1010, 1011, 1012, 1024, 1025, 1026, 1038, 1039, 1040, 1052, 1053, 1054,
      1066, 1067, 1068, 1080, 1081, 1082, 1094, 1095, 1096, 1108, 1109, 1110,
      1122, 1123, 1124, 1136, 1137, 1138, 1150, 1151, 1152, 1164, 1165, 1166,
      1178, 1179, 1180, 1192, 1193, 1194, 1206, 1207, 1208, 1220, 1221, 1222,
      1234, 1235, 1236, 1248, 1249, 1250, 1262, 1263, 1264, 1276, 1277, 1278,
      1290, 1291, 1292, 1304, 1305, 1306, 1318, 1319, 1320, 1332, 1333, 1334,
      1346, 1347, 1348, 1360, 1361, 1362, 1374, 1375, 1376, 1388, 1389, 1390,
      1402, 1403, 1404, 1416, 1417, 1418, 1430, 1431, 1432, 1444, 1445, 1446,
      1458, 1459, 1460, 1472, 1473, 1474, 1486, 1487, 1488, 1500, 1501, 1502,
      1514, 1515, 1516, 1528, 1529, 1530, 1542, 1543, 1544, 1556, 1557, 1558,
      1570, 1571, 1572, 1584, 1585, 1586, 1598, 1599, 1600, 1612, 1613, 1614,
      1626, 1627, 1628, 1640, 1641, 1642, 1654, 1655, 1656, 1668, 1669, 1670,
      1682, 1683, 1684, 1696, 1697, 1698, 1710, 1711, 1712, 1724, 1725, 1726,
      1738, 1739, 1740, 1752, 1753, 1754, 1766, 1767, 1768, 1780, 1781, 1782,
      1794, 1795, 1796, 1808, 1809, 1810, 1822, 1823, 1824, 1836, 1837, 1838,
      1850, 1851, 1852, 1864, 1865, 1866, 1878, 1879, 1880, 1892, 1893, 1894,
      1906, 1907, 1908, 1920, 1921, 1922, 1934, 1935, 1936, 1948, 1949, 1950,
      1962, 1963, 1964, 1976, 1977, 1978, 1990, 1991, 1992, 2004, 2005, 2006,
      2018, 2019, 2020, 2032, 2033, 2034, 2046, 2047, 2048, 2060, 2061, 2062,
      2074, 2075, 2076, 2088, 2089, 2090, 2102, 2103, 2104, 2116, 2117, 2118,
      2130, 2131, 2132, 2144, 2145, 2146, 2158, 2159, 2160, 2172, 2173, 2174,
      2186, 2187, 2188, 2200, 2201, 2202, 2214, 2215, 2216, 2228, 2229, 2230,
      2242, 2243, 2244, 2256, 2257, 2258, 2270, 2271, 2272, 2284, 2285, 2286,
      2298, 2299, 2300, 2312, 2313, 2314, 2326, 2327, 2328, 2340, 2341, 2342,
      2354, 2355, 2356, 2368, 2369, 2370, 2382, 2383, 2384, 2396, 2397, 2398,
      2410, 2411, 2412, 2424, 2425, 2426, 2438, 2439, 2440, 2452, 2453, 2454,
      2466, 2467, 2468, 2480, 2481, 2482, 2494, 2495, 2496, 2508, 2509, 2510,
      2522, 2523, 2524, 2536, 2537, 2538, 2550, 2551, 2552, 2564, 2565, 2566,
      2578, 2579, 2580, 2592, 2593, 2594, 2606, 2607, 2608, 2620, 2621, 2622,
      2634, 2635, 2636, 2648, 2649, 2650, 2662, 2663, 2664, 2676, 2677, 2678,
      2690, 2691, 2692, 2704, 2705, 2706, 2718, 2719, 2720, 2732, 2733, 2734},
     {   7,    8,   21,   22,   35,   36,   49,   50,   63,   64,   77,   78,
        91,   92,  105,  106,  119,  120,  133,  134,  147,  148,  161,  162,
       175,  176,  189,  190,  203,  204,  217,  218,  231,  232,  245,  246,
       259,  260,  273,  274,  287,  288,  301,  302,  315,  316,  329,  330,
       343,  344,  357,  358,  371,  372,  385,  386,  399,  400,  413,  414,
       427,  428,  441,  442,  455,  456,  469,  470,  483,  484,  497,  498,
       511,  512,  525,  526,  539,  540,  553,  554,  567,  568,  581,  582,
       595,  596,  609,  610,  623,  624,  637,  638,  651,  652,  665,  666,
       679,  680,  693,  694,  707,  708,  721,  722,  735,  736,  749,  750,
       763,  764,  777,  778,  791,  792,  805,  806,  819,  820,  833,  834,
       847,  848,  861,  862,  875,  876,  889,  890,  903,  904,  917,  918,
       931,  932,  945,  946,  959,  960,  973,  974,  987,  988, 1001, 1002,
      1015, 1016, 1029, 1030, 1043, 1044, 1057, 1058, 1071, 1072, 1085, 1086,
      1099, 1100, 1113, 1114, 1127, 1128, 1141, 1142, 1155, 1156, 1169, 1170,
      1183, 1184, 1197, 1198, 1211, 1212, 1225, 1226, 1239, 1240, 1253, 1254,
      1267, 1268, 1281, 1282, 1295, 1296, 1309, 1310, 1323, 1324, 1337, 1338,
      1351, 1352, 1365, 1366, 1379, 1380, 1393, 1394, 1407, 1408, 1421, 1422,
      1435, 1436, 1449, 1450, 1463, 1464, 1477, 1478, 1491, 1492, 1505, 1506,
      1519, 1520, 1533, 1534, 1547, 1548, 1561, 1562, 1575, 1576, 1589, 1590,
      1603, 1604, 1617, 1618, 1631, 1632, 1645, 1646, 1659, 1660, 1673, 1674,
      1687, 1688, 1701, 1702, 1715, 1716, 1729, 1730, 1743, 1744, 1757, 1758,
      1771, 1772, 1785, 1786, 1799, 1800, 1813, 1814, 1827, 1828, 1841, 1842,
      1855, 1856, 1869, 1870, 1883, 1884, 1897, 1898, 1911, 1912, 1925, 1926,
      1939, 1940, 1953, 1954, 1967, 1968, 1981, 1982, 1995, 1996, 2009, 2010,
      2023, 2024, 2037, 2038, 2051, 2052, 2065, 2066, 2079, 2080, 2093, 2094,
      2107, 2108, 2121, 2122, 2135, 2136, 2149, 2150, 2163, 2164, 2177, 2178,
      2191, 2192, 2205, 2206, 2219, 2220, 2233, 2234, 2247, 2248, 2261, 2262,
      2275, 2276, 2289, 2290, 2303, 2304, 2317, 2318, 2331, 2332, 2345, 2346,
      2359, 2360, 2373, 2374, 2387, 2388, 2401, 2402, 2415, 2416, 2429, 2430,
      2443, 2444, 2457, 2458, 2471, 2472, 2485, 2486, 2499, 2500, 2513, 2514,
      2527, 2528, 2541, 2542, 2555, 2556, 2569, 2570, 2583, 2584, 2597, 2598,
      2611, 2612, 2625, 2626, 2639, 2640, 2653, 2654, 2667, 2668, 2681, 2682,
      2695, 2696, 2709, 2710, 2723, 2724, 2737, 2738},
     {  11,   12,   13,   25,   26,   27,   39,   40,   41,   53,   54,   55,
        67,   68,   69,   81,   82,   83,   95,   96,   97,  109,  110,  111,
       123,  124,  125,  137,  138,  139,  151,  152,  153,  165,  166,  167,
       179,  180,  181,  193,  194,  195,  207,  208,  209,  221,  222,  223,
       235,  236,  237,  249,  250,  251,  263,  264,  265,  277,  278,  279,
       291,  292,  293,  305,  306,  307,  319,  320,  321,  333,  334,  335,
       347,  348,  349,  361,  362,  363,  375,  376,  377,  389,  390,  391,
       403,  404,  405,  417,  418,  419,  431,  432,  433,  445,  446,  447,
       459,  460,  461,  473,  474,  475,  487,  488,  489,  501,  502,  503,
       515,  516,  517,  529,  530,  531,  543,  544,  545,  557,  558,  559,
       571,  572,  573,  585,  586,  587,  599,  600,  601,  613,  614,  615,
       627,  628,  629,  641,  642,  643,  655,  656,  657,  669,  670,  671,
       683,  684,  685,  697,  698,  699,  711,  712,  713,  725,  726,  727,
       739,  740,  741,  753,  754,  755,  767,  768,  769,  781,  782,  783,
       795,  796,  797,  809,  810,  811,  823,  824,  825,  837,  838,  839,
       851,  852,  853,  865,  866,  867,  879,  880,  881,  893,  894,  895,
       907,  908,  909,  921,  922,  923,  935,  936,  937,  949,  950,  951,
       963,  964,  965,  977,  978,  979,  991,  992,  993, 1005, 1006, 1007,
      1019, 1020, 1021, 1033, 1034, 1035, 1047, 1048, 1049, 1061, 1062, 1063,
      1075, 1076, 1077, 1089, 1090, 1091, 1103, 1104, 1105, 1117, 1118, 1119,
      1131, 1132, 1133, 1145, 1146, 1147, 1159, 1160, 1161, 1173, 1174, 1175,
      1187, 1188, 1189, 1201, 1202, 1203, 1215, 1216, 1217, 1229, 1230, 1231,
      1243, 1244, 1245, 1257, 1258, 1259, 1271, 1272, 1273, 1285, 1286, 1287,
      1299, 1300, 1301, 1313, 1314, 1315, 1327, 1328, 1329, 1341, 1342, 1343,
      1355, 1356, 1357, 1369, 1370, 1371, 1383, 1384, 1385, 1397, 1398, 1399,
      1411, 1412, 1413, 1425, 1426, 1427, 1439, 1440, 1441, 1453, 1454, 1455,
      1467, 1468, 1469, 1481, 1482, 1483, 1495, 1496, 1497, 1509, 1510, 1511,
      1523, 1524, 1525, 1537, 1538, 1539, 1551, 1552, 1553, 1565, 1566, 1567,
      1579, 1580, 1581, 1593, 1594, 1595, 1607, 1608, 1609, 1621, 1622, 1623,
      1635, 1636, 1637, 1649, 1650, 1651, 1663, 1664, 1665, 1677, 1678, 1679,
      1691, 1692, 1693, 1705, 1706, 1707, 1719, 1720, 1721, 1733, 1734, 1735,
      1747, 1748, 1749, 1761, 1762, 1763, 1775, 1776, 1777, 1789, 1790, 1791,
      1803, 1804, 1805, 1817, 1818, 1819, 1831, 1832, 1833, 1845, 1846, 1847,
      1859, 1860, 1861, 1873, 1874, 1875, 1887, 1888, 1889, 1901, 1902, 1903,
      1915, 1916, 1917, 1929, 1930, 1931, 1943, 1944, 1945, 1957, 1958, 1959,
      1971, 1972, 1973, 1985, 1986, 1987, 1999, 2000, 2001, 2013, 2014, 2015,
      2027, 2028, 2029, 2041, 2042, 2043, 2055, 2056, 2057, 2069, 2070, 2071,
      2083, 2084, 2085, 2097, 2098, 2099, 2111, 2112, 2113, 2125, 2126, 2127,
      2139, 2140, 2141, 2153, 2154, 2155, 2167, 2168, 2169, 2181, 2182, 2183,
      2195, 2196, 2197, 2209, 2210, 2211, 2223, 2224, 2225, 2237, 2238, 2239,
      2251, 2252, 2253, 2265, 2266, 2267, 2279, 2280, 2281, 2293, 2294, 2295,
      2307, 2308, 2309, 2321, 2322, 2323, 2335, 2336, 2337, 2349, 2350, 2351,
      2363, 2364, 2365, 2377, 2378, 2379, 2391, 2392, 2393, 2405, 2406, 2407,
      2419, 2420, 2421, 2433, 2434, 2435, 2447, 2448, 2449, 2461, 2462, 2463,
      2475, 2476, 2477, 2489, 2490, 2491, 2503, 2504, 2505, 2517, 2518, 2519,
      2531, 2532, 2533, 2545, 2546, 2547, 2559, 2560, 2561, 2573, 2574, 2575,
      2587, 2588, 2589, 2601, 2602, 2603, 2615, 2616, 2617, 2629, 2630, 2631,
      2643, 2644, 2645, 2657, 2658, 2659, 2671, 2672, 2673, 2685, 2686, 2687,
      2699, 2700, 2701, 2713, 2714, 2715, 2727, 2728, 2729, 2741, 2742, 2743}}};

  for (size_t i = 0; i < 3; ++i)
    for (size_t j = 0; j < 392; ++j)
      EXPECT_EQ(groups2[0][i][j], ref3De1[i][j]);

  for (size_t i = 0; i < ref3De2.size(); ++i)
    for (size_t j = 0; j < ref3De2[i].size(); ++j)
      EXPECT_EQ(groups2[1][i][j], ref3De2[i][j]);
#else
  ASSERT_EQ(groups2.size(), 1U);
  ASSERT_EQ(groups2[0].size(), 1U);
  ASSERT_EQ(groups2[0][0].size(), 2744U);
  for (int i = 0; i < 2744; ++i)
    EXPECT_EQ(groups2[0][0][i], i);
#endif
}
